name: Build Loyalsoldier geosite & geoip index

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * 0"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download geoview (official)
        run: |
          curl -L -o geoview \
            https://github.com/snowie2000/geoview/releases/latest/download/geoview-linux-amd64
          chmod +x geoview

      - name: Download latest dat files
        run: |
          mkdir -p tmp
          curl -L -o tmp/geosite.dat \
            https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geosite.dat
          curl -L -o tmp/geoip.dat \
            https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geoip.dat

      - name: Build geosite index (using geoview)
        run: |
          mkdir -p data/loyalsoldier
          ./geoview -type geosite -input tmp/geosite.dat -list > data/loyalsoldier/geosite-index.txt

      - name: Build geoip index (using geoview)
        run: |
          ./geoview -type geoip -input tmp/geoip.dat -list > data/loyalsoldier/geoip-index.txt

      - name: Convert index to JSON
        run: |
          jq -R -s 'split("\n") | map(select(length>0))' \
            data/loyalsoldier/geosite-index.txt \
            > data/loyalsoldier/geosite-index.json

          jq -R -s 'split("\n") | map(select(length>0))' \
            data/loyalsoldier/geoip-index.txt \
            > data/loyalsoldier/geoip-index.json

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add data/loyalsoldier
          if git diff --cached --quiet; then
            echo "No changes"
          else
            git commit -m "chore: update Loyalsoldier geosite/geoip index"
            git push
          fi
